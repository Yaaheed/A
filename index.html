<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AUTO FIX</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
            --gray: #95a5a6;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }

        /* Header & Navigation */
        header {
            background: var(--primary);
            color: white;
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo img {
            height: 2rem;
            width: auto;
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 700;
        }

        nav ul {
            display: flex;
            list-style: none;
            gap: 1.5rem;
        }

        nav a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: var(--transition);
            padding: 0.5rem;
            border-radius: 4px;
        }

        nav a:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .user-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .btn {
            padding: 0.6rem 1.2rem;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
        }

        .btn-primary {
            background: var(--secondary);
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--light);
            color: white;
        }

        .btn-outline:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        /* Main Content */
        .main-content {
            padding: 2rem 0;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 3fr;
            gap: 1.5rem;
        }

        /* Sidebar */
        .sidebar {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            height: fit-content;
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-menu li {
            margin-bottom: 0.8rem;
        }

        .sidebar-menu a {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--dark);
            text-decoration: none;
            padding: 0.8rem;
            border-radius: 4px;
            transition: var(--transition);
        }

        .sidebar-menu a:hover, .sidebar-menu a.active {
            background: var(--light);
            color: var(--secondary);
        }

        .sidebar-menu i {
            width: 20px;
            text-align: center;
        }

        /* Dashboard Content */
        .dashboard-content {
            display: grid;
            gap: 1.5rem;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 0.8rem;
            border-bottom: 1px solid #eee;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark);
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1.5rem 1rem;
            background: var(--light);
            border-radius: 8px;
            text-decoration: none;
            color: var(--dark);
            transition: var(--transition);
            cursor: pointer;
        }

        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
            color: var(--secondary);
        }

        .action-btn i {
            font-size: 2rem;
            margin-bottom: 0.8rem;
        }

        /* OBD Scanner Section */
        .obd-scanner {
            background: linear-gradient(135deg, var(--primary), #1a2530);
            color: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .scanner-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            align-items: center;
        }

        .scanner-info {
            padding: 1.5rem;
        }

        .scanner-visual {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1.5rem;
        }

        .scanner-device {
            width: 200px;
            height: 150px;
            background: #1a2530;
            border: 2px solid var(--secondary);
            border-radius: 12px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .scanner-device:before {
            content: '';
            position: absolute;
            width: 100%;
            height: 20px;
            background: var(--secondary);
            top: 0;
        }

        .scanner-device:after {
            content: '';
            position: absolute;
            width: 30px;
            height: 10px;
            background: var(--success);
            border-radius: 4px;
            bottom: 15px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.2; }
            50% { opacity: 1; }
            100% { opacity: 0.2; }
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 1rem 0;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--gray);
        }

        .status-connected {
            background: var(--success);
        }

        /* OBD-II Data Display */
        .scanner-data {
            margin-top: 1rem;
        }

        .data-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.8rem;
            margin-top: 0.5rem;
        }

        .data-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .data-label {
            font-weight: 600;
            color: var(--light);
        }

        .data-value {
            font-weight: 700;
            color: white;
        }

        .dtc-code {
            background: var(--danger);
            color: white;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-size: 0.8rem;
            font-weight: 600;
            margin: 0.1rem;
            display: inline-block;
        }

        .dtc-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.2rem;
        }

        /* OBD-II Visualization */
        .obd-visualization {
            margin-top: 1.5rem;
        }

        .gauges-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .gauge {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .gauge-label {
            font-size: 0.9rem;
            color: var(--light);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .gauge-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            margin-bottom: 0.5rem;
        }

        .gauge-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .gauge-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--warning), var(--danger));
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* Troubleshooting Flow */
        .troubleshooting-flow {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .flow-step {
            background: var(--light);
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid var(--secondary);
        }

        .step-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .step-title {
            font-weight: 600;
        }

        .step-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.8rem;
            margin-top: 1rem;
        }

        .option-btn {
            padding: 0.8rem;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: var(--transition);
            text-align: left;
        }

        .option-btn:hover {
            background: var(--secondary);
            color: white;
        }

        .flow-step {
            display: none;
        }

        .flow-step.active {
            display: block;
        }

        .troubleshooting-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid #eee;
        }

        .diagnostic-results {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--light);
            border-radius: 8px;
            border-left: 4px solid var(--secondary);
        }

        .diagnostic-results h4 {
            margin-bottom: 0.5rem;
            color: var(--dark);
        }

        .solution-steps {
            margin-top: 1rem;
        }

        .solution-step {
            display: flex;
            align-items: flex-start;
            margin-bottom: 1rem;
            padding: 0.8rem;
            background: white;
            border-radius: 6px;
            border-left: 3px solid var(--secondary);
        }

        .step-number {
            width: 24px;
            height: 24px;
            background: var(--secondary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 0.8rem;
            flex-shrink: 0;
        }

        .safety-warning {
            background: var(--warning);
            color: #333;
            padding: 0.8rem;
            border-radius: 6px;
            margin: 1rem 0;
            border-left: 4px solid #f39c12;
        }

        .safety-warning strong {
            display: block;
            margin-bottom: 0.5rem;
        }

        /* Repair Guide Styles */
        .repair-guide-content {
            max-height: 70vh;
            overflow-y: auto;
        }

        .guide-categories {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #eee;
        }

        .guide-category-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
        }

        .guide-category-btn:hover, .guide-category-btn.active {
            background: var(--secondary);
            color: white;
            border-color: var(--secondary);
        }

        .guide-list {
            display: grid;
            gap: 1rem;
        }

        .guide-item {
            background: var(--light);
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid var(--secondary);
            cursor: pointer;
            transition: var(--transition);
        }

        .guide-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .guide-item h4 {
            margin-bottom: 0.5rem;
            color: var(--dark);
        }

        .guide-item p {
            color: var(--gray);
            font-size: 0.9rem;
        }

        .guide-item .difficulty {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }

        .difficulty.easy { background: var(--success); color: white; }
        .difficulty.medium { background: var(--warning); color: white; }
        .difficulty.hard { background: var(--danger); color: white; }

        .large-modal .modal-content {
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .guide-detail-content {
            line-height: 1.6;
        }

        .guide-detail-content h3 {
            color: var(--dark);
            margin: 1.5rem 0 1rem 0;
        }

        .guide-detail-content h4 {
            color: var(--dark);
            margin: 1rem 0 0.5rem 0;
        }

        .guide-detail-content ol, .guide-detail-content ul {
            margin-left: 1.5rem;
        }

        .guide-detail-content li {
            margin-bottom: 0.5rem;
        }

        .guide-tools, .guide-parts {
            background: var(--light);
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
        }

        .guide-tools h4, .guide-parts h4 {
            margin-bottom: 0.5rem;
            color: var(--dark);
        }

        /* Upload Modal Styles */
        .upload-content {
            text-align: center;
        }

        .upload-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .upload-option {
            background: var(--light);
            padding: 1.5rem 1rem;
            border-radius: 8px;
            border: 2px dashed #ddd;
            transition: var(--transition);
        }

        .upload-option:hover {
            border-color: var(--secondary);
            background: rgba(52, 152, 219, 0.05);
        }

        .upload-option i {
            font-size: 2rem;
            color: var(--secondary);
            margin-bottom: 0.5rem;
        }

        .upload-option h4 {
            margin-bottom: 0.5rem;
            color: var(--dark);
        }

        .upload-option p {
            color: var(--gray);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .uploaded-files {
            margin-top: 1rem;
        }

        .uploaded-file {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--light);
            padding: 0.8rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .file-info i {
            color: var(--secondary);
        }

        /* Repair History */
        .history-list {
            display: grid;
            gap: 1rem;
        }

        .history-item {
            display: grid;
            grid-template-columns: 1fr auto;
            padding: 1rem;
            background: var(--light);
            border-radius: 8px;
        }

        .history-details h4 {
            margin-bottom: 0.5rem;
        }

        .history-date {
            color: var(--gray);
            font-size: 0.9rem;
        }

        /* Chat Interface */
        .chat-container {
            display: grid;
            grid-template-rows: auto 1fr auto;
            height: 400px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }

        .chat-header {
            background: var(--primary);
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            max-width: 80%;
            padding: 0.8rem;
            border-radius: 8px;
        }

        .message.received {
            background: #e6f7ff;
            align-self: flex-start;
        }

        .message.sent {
            background: var(--light);
            align-self: flex-end;
        }

        .chat-input {
            display: flex;
            padding: 1rem;
            border-top: 1px solid #ddd;
            background: white;
        }

        .chat-input input {
            flex: 1;
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 0.5rem;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 0.8rem;
            border-bottom: 1px solid #eee;
        }

        .close {
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        /* Responsive Design */
        @media (max-width: 992px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .scanner-content {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            nav ul {
                display: none;
            }
            
            .quick-actions {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 576px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .user-actions {
                width: 100%;
                justify-content: center;
            }

            .quick-actions {
                grid-template-columns: 1fr;
            }

            .step-options {
                grid-template-columns: 1fr;
            }

            .history-item {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
        }

        /* Loader Styles */
        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary), #1a2530);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        .loader-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loader-content {
            text-align: center;
            color: white;
            animation: fadeInUp 0.8s ease;
        }

        .loader-spinner {
            width: 80px;
            height: 80px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--secondary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem;
        }

        .loader-content h2 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }

        .loader-content p {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 2rem;
        }

        .loader-progress {
            width: 300px;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            overflow: hidden;
            margin: 0 auto;
        }

        .loader-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary), var(--success));
            border-radius: 2px;
            animation: progress 3s ease-in-out;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes progress {
            0% { width: 0%; }
            70% { width: 90%; }
            100% { width: 100%; }
        }

        /* Enhanced Button Styles */
        .btn-loading {
            position: relative;
            color: transparent !important;
        }

        .btn-loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Dark Mode Styles */
        body.dark-mode {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --light: #34495e;
            --dark: #ecf0f1;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --gray: #7f8c8d;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            background-color: #1a252f;
            color: #ecf0f1;
        }

        body.dark-mode .card,
        body.dark-mode .sidebar,
        body.dark-mode .modal-content {
            background: var(--light);
            color: var(--dark);
        }

        body.dark-mode .action-btn {
            background: var(--light);
            color: var(--dark);
        }

        body.dark-mode .action-btn:hover {
            background: var(--secondary);
            color: white;
        }

        /* Animation Enhancements */
        .fade-in {
            animation: fadeIn 0.5s ease;
        }

        .slide-in-left {
            animation: slideInLeft 0.5s ease;
        }

        .slide-in-right {
            animation: slideInRight 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideInLeft {
            from { transform: translateX(-30px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideInRight {
            from { transform: translateX(30px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Enhanced Hover Effects */
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .sidebar-menu a:hover {
            transform: translateX(5px);
        }

        /* Typing Indicator for Chat */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.8rem;
            color: var(--gray);
            font-style: italic;
        }

        .typing-dots {
            display: flex;
            gap: 0.2rem;
        }

        .typing-dots span {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--gray);
            animation: typing 1.4s infinite;
        }

        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        /* Toggle Switch Styles */
        .toggle-label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-weight: 600;
            user-select: none;
        }

        .toggle-label input[type="checkbox"] {
            display: none;
        }

        .toggle-slider {
            position: relative;
            width: 50px;
            height: 24px;
            background: var(--gray);
            border-radius: 24px;
            transition: background 0.3s ease;
        }

        .toggle-slider::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }

        .toggle-label input[type="checkbox"]:checked + .toggle-slider {
            background: var(--secondary);
        }

        .toggle-label input[type="checkbox"]:checked + .toggle-slider::before {
            transform: translateX(26px);
        }
    </style>
</head>
<body>
    <!-- Loader Page -->
    <div id="loader" class="loader-overlay">
        <div class="loader-content">
            <div class="loader-spinner"></div>
            <h2>Loading AUTO FIX</h2>
            <p>Initializing your automotive diagnostic system...</p>
            <div class="loader-progress">
                <div class="loader-bar"></div>
            </div>
        </div>
    </div>
    <!-- Header -->
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <img src="assets/logo.png" alt="AUTO FIX Logo">
                    <h1>AUTO FIX</h1>
                </div>
                <nav>
                    <ul>
                        <li><a href="#" class="active">Dashboard</a></li>
                        <li><a href="#">Diagnostics</a></li>
                        <li><a href="#">Repairs</a></li>
                        <li><a href="#">History</a></li>
                        <li><a href="#">Chat</a></li>
                    </ul>
                </nav>
                <div class="user-actions">
                </div>

            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <div class="dashboard">
                <!-- Sidebar -->
                <aside class="sidebar">
                    <ul class="sidebar-menu">
                        <li><a href="#" class="active" onclick="showDashboard(); return false;"><i class="fas fa-home"></i> Dashboard</a></li>
                        <li><a href="#" onclick="showDiagnostics(); return false;"><i class="fas fa-stethoscope"></i> Diagnostics</a></li>
                        <li><a href="#" onclick="showRepairs(); return false;"><i class="fas fa-tools"></i> Repairs</a></li>
                        <li><a href="#" onclick="showHistory(); return false;"><i class="fas fa-history"></i> History</a></li>
                </li>
                <li><a href="javascript:void(0);" id="settingsBtn"><i class="fas fa-cog"></i> Settings</a></li>
                <li><a href="#" onclick="showHelp(); return false;"><i class="fas fa-question-circle"></i> Help & Support</a></li>
                        <li><a href="javascript:void(0);" id="vehicleValueBtn"><i class="fas fa-dollar-sign"></i> Vehicle Value</a></li>
                    </ul>
                </aside>

                <!-- Dashboard Content -->
                <div class="dashboard-content">
                    <!-- Quick Actions -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Quick Actions</h2>
                        </div>
                <div class="quick-actions">
                    <div class="action-btn" id="newDiagnosisBtn">
                        <i class="fas fa-stethoscope"></i>
                        <span>New Diagnosis</span>
                    </div>
                    <div class="action-btn" id="repairGuideBtn">
                        <i class="fas fa-tools"></i>
                        <span>Repair Guide</span>
                    </div>
                    <div class="action-btn" id="repairHistoryBtn">
                        <i class="fas fa-history"></i>
                        <span>Repair History</span>
                    </div>
                    <div class="action-btn" id="scheduleBtn">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Schedule</span>
                    </div>
                    <div class="action-btn" id="chatSupportBtn">
                        <i class="fas fa-comment-medical"></i>
                        <span>Chat Support</span>
                    </div>
                    <div class="action-btn" id="uploadDataBtn">
                        <i class="fas fa-upload"></i>
                        <span>Upload Data</span>
                    </div>
                    <div class="action-btn" id="vehicleValueBtn">
                        <i class="fas fa-car"></i>
                        <span>Vehicle Value</span>
                    </div>
                </div>
                    </div>

                    <!-- OBD Scanner Section -->
                    <div class="card obd-scanner">
                        <div class="card-header">
                            <h2 class="card-title">OBD Scanner Integration</h2>
                        </div>
                        <div class="scanner-content">
                            <div class="scanner-info">
                                <p>Connect your OBD-II scanner to perform real-time vehicle diagnostics</p>
                                <div class="connection-status">
                                    <div class="status-indicator" id="statusIndicator"></div>
                                    <span id="statusText">Disconnected</span>
                                </div>
    <button class="btn btn-primary" id="connectScannerBtn">Connect Scanner</button>
    <button class="btn btn-warning" id="clearDTCsBtn" style="display: none; margin-left: 0.5rem;">Clear DTCs</button>
    <button class="btn btn-danger" id="activeTestBtn" style="display: none; margin-left: 0.5rem;">Perform Active Tests</button>
    <div class="scanner-data" style="margin-top: 1rem;">
                                    <p>Supported vehicles: All OBD-II compliant cars (1996 and newer)</p>
                                    <p>Reads: Diagnostic Trouble Codes (DTCs), live sensor data, vehicle parameters</p>
                                </div>
                            </div>
                            <div class="scanner-visual">
                                <div class="scanner-device">
                                    <i class="fas fa-bluetooth-b" style="font-size: 3rem; color: #2c3e50;"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Troubleshooting Flow -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Symptom-Based Troubleshooting</h2>
                        </div>
                        <div class="troubleshooting-flow" id="troubleshootingFlow">
                            <div class="flow-step active" id="step1">
                                <div class="step-header">
                                    <h3 class="step-title">What problem are you experiencing?</h3>
                                    <span>Step 1 of 4</span>
                                </div>
                                <p>Select the issue that best matches your vehicle's symptoms</p>
                                <div class="step-options">
                                    <button class="option-btn" data-problem="engine-wont-start">Engine won't start</button>
                                    <button class="option-btn" data-problem="engine-misfires">Engine misfires or runs rough</button>
                                    <button class="option-btn" data-problem="poor-fuel-economy">Poor fuel economy</button>
                                    <button class="option-btn" data-problem="warning-light">Warning light on dashboard</button>
                                    <button class="option-btn" data-problem="braking-issues">Braking issues</button>
                                    <button class="option-btn" data-problem="overheating">Engine overheating</button>
                                    <button class="option-btn" data-problem="strange-noises">Strange noises</button>
                                    <button class="option-btn" data-problem="other">Other</button>
                                </div>
                            </div>
                        </div>
                        <div class="troubleshooting-controls">
                            <button class="btn btn-outline" id="prevStepBtn" style="display: none;">Previous</button>
                            <button class="btn btn-outline" id="restartTroubleshootingBtn" style="display: none;">Restart</button>
                        </div>
                    </div>

                    <!-- Repair History -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Recent Repairs</h2>
                            <a href="#" style="color: var(--secondary); text-decoration: none;">View All</a>
                        </div>
                        <div class="history-list" id="repairHistoryList">
                            <div class="history-item">
                                <div class="history-details">
                                    <h4>Oil Change and Filter Replacement</h4>
                                    <p>Vehicle: Toyota Camry 2018</p>
                                    <span class="history-date">Completed: June 15, 2023</span>
                                </div>
                                <div class="history-status">
                                    <span style="background: var(--success); color: white; padding: 0.3rem 0.6rem; border-radius: 4px;">Completed</span>
                                </div>
                            </div>
                            <div class="history-item">
                                <div class="history-details">
                                    <h4>Brake Pad Replacement</h4>
                                    <p>Vehicle: Honda Civic 2020</p>
                                    <span class="history-date">Scheduled: July 2, 2023</span>
                                </div>
                                <div class="history-status">
                                    <span style="background: var(--warning); color: white; padding: 0.3rem 0.6rem; border-radius: 4px;">Scheduled</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Chat with Mechanics -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Chat with Mechanics</h2>
                        </div>
                        <div class="chat-container">
                            <div class="chat-header">
                                <div>Mechanic Support</div>
                                <div><i class="fas fa-circle" style="color: var(--success); font-size: 0.7rem;"></i> Online</div>
                            </div>
                            <div class="chat-messages" id="chatMessages">
                                <div class="message received">
                                    <p>Hello! How can I help you with your vehicle today?</p>
                                    <span class="message-time">10:30 AM</span>
                                </div>
                                <div class="message sent">
                                    <p>Hi, my car is making a strange noise when I turn the steering wheel.</p>
                                    <span class="message-time">10:32 AM</span>
                                </div>
                                <div class="message received">
                                    <p>Could you describe the noise? Is it a whining, grinding, or clicking sound?</p>
                                    <span class="message-time">10:33 AM</span>
                                </div>
                            </div>
                            <div class="chat-input">
                                <input type="text" placeholder="Type your message..." id="chatInput">
                                <button class="btn btn-primary" id="sendMessageBtn"><i class="fas fa-paper-plane"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>



    <!-- New Diagnosis Modal -->
    <div class="modal" id="diagnosisModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>New Diagnosis</h2>
                <span class="close" data-modal="diagnosisModal">&times;</span>
            </div>
            <form id="diagnosisForm">
                <div class="form-group">
                    <label for="vehicleType">Vehicle Type</label>
                    <select id="vehicleType" required>
                        <option value="">Select vehicle type</option>
                        <option value="car">Car</option>
                        <option value="truck">Truck</option>
                        <option value="suv">SUV</option>
                        <option value="motorcycle">Motorcycle</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="vehicleMake">Make</label>
                    <input type="text" id="vehicleMake" required placeholder="e.g. Toyota">
                </div>
                <div class="form-group">
                    <label for="vehicleModel">Model</label>
                    <input type="text" id="vehicleModel" required placeholder="e.g. Camry">
                </div>
                <div class="form-group">
                    <label for="vehicleYear">Year</label>
                    <input type="number" id="vehicleYear" min="1950" max="2023" required>
                </div>
                <div class="form-group">
                    <label for="symptoms">Describe the symptoms</label>
                    <textarea id="symptoms" rows="3" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Start Diagnosis</button>
            </form>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Settings</h2>
                <span class="close" data-modal="settingsModal">&times;</span>
            </div>
            <form id="settingsForm">
                <div class="form-group">
                    <label for="geminiApiKey">Gemini API Key</label>
                    <input type="password" id="geminiApiKey" placeholder="Enter your Gemini API key">
                    <small>Get your API key from <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a></small>
                </div>
                <div class="form-group">
                    <label class="toggle-label">
                        <input type="checkbox" id="darkModeToggle">
                        <span class="toggle-slider"></span>
                        Dark Mode
                    </label>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Save Settings</button>
            </form>
        </div>
    </div>

    <!-- Vehicle Value Modal -->
    <div class="modal" id="vehicleValueModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Estimate Vehicle Value</h2>
                <span class="close" data-modal="vehicleValueModal">&times;</span>
            </div>
            <form id="vehicleValueForm">
                <div class="form-group">
                    <label for="vvMake">Make</label>
                    <input type="text" id="vvMake" placeholder="e.g. Toyota" required>
                </div>
                <div class="form-group">
                    <label for="vvModel">Model</label>
                    <input type="text" id="vvModel" placeholder="e.g. Camry" required>
                </div>
                <div class="form-group">
                    <label for="vvYear">Year</label>
                    <input type="number" id="vvYear" min="1950" max="2024" placeholder="e.g. 2018" required>
                </div>
                <div class="form-group">
                    <label for="vvMileage">Mileage (km)</label>
                    <input type="number" id="vvMileage" min="0" placeholder="e.g. 50000" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Estimate Value</button>
            </form>
            <div id="vehicleValueResult" style="margin-top: 1rem; font-weight: 600;"></div>
        </div>
    </div>

    <!-- Vehicle Value Modal -->
    <div class="modal" id="vehicleValueModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Vehicle Value Estimator</h2>
                <span class="close" data-modal="vehicleValueModal">&times;</span>
            </div>
            <form id="vehicleValueForm">
                <div class="form-group">
                    <label for="vvMake">Make</label>
                    <input type="text" id="vvMake" placeholder="e.g. Toyota" required>
                </div>
                <div class="form-group">
                    <label for="vvModel">Model</label>
                    <input type="text" id="vvModel" placeholder="e.g. Camry" required>
                </div>
                <div class="form-group">
                    <label for="vvYear">Year</label>
                    <input type="number" id="vvYear" min="1950" max="2024" placeholder="e.g. 2018" required>
                </div>
                <div class="form-group">
                    <label for="vvMileage">Mileage (km)</label>
                    <input type="number" id="vvMileage" min="0" placeholder="e.g. 50000" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Estimate Value</button>
            </form>
            <div id="vehicleValueResult" style="margin-top: 1rem; font-weight: 600;"></div>
        </div>
    </div>

    <!-- Repair Guide Modal -->
    <div class="modal" id="repairGuideModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Repair Guides</h2>
                <span class="close" data-modal="repairGuideModal">&times;</span>
            </div>
            <div class="repair-guide-content">
                <div class="guide-categories">
                    <button class="guide-category-btn active" data-category="engine">Engine</button>
                    <button class="guide-category-btn" data-category="brakes">Brakes</button>
                    <button class="guide-category-btn" data-category="transmission">Transmission</button>
                    <button class="guide-category-btn" data-category="electrical">Electrical</button>
                    <button class="guide-category-btn" data-category="suspension">Suspension</button>
                    <button class="guide-category-btn" data-category="maintenance">Maintenance</button>
                </div>
                <div class="guide-list" id="guideList">
                    <!-- Guides will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Individual Guide Modal -->
    <div class="modal" id="guideDetailModal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h2 id="guideTitle">Guide Title</h2>
                <span class="close" data-modal="guideDetailModal">&times;</span>
            </div>
            <div class="guide-detail-content" id="guideDetailContent">
                <!-- Guide content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Scheduling Modal -->
    <div class="modal" id="scheduleModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Schedule Repair</h2>
                <span class="close" data-modal="scheduleModal">&times;</span>
            </div>
            <form id="scheduleForm">
                <div class="form-group">
                    <label for="serviceType">Service Type</label>
                    <select id="serviceType" required>
                        <option value="">Select service type</option>
                        <option value="oil-change">Oil Change</option>
                        <option value="brake-service">Brake Service</option>
                        <option value="engine-repair">Engine Repair</option>
                        <option value="transmission">Transmission Service</option>
                        <option value="electrical">Electrical Repair</option>
                        <option value="diagnostic">Diagnostic Service</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="preferredDate">Preferred Date</label>
                    <input type="date" id="preferredDate" required>
                </div>
                <div class="form-group">
                    <label for="preferredTime">Preferred Time</label>
                    <select id="preferredTime" required>
                        <option value="">Select time</option>
                        <option value="morning">Morning (9AM - 12PM)</option>
                        <option value="afternoon">Afternoon (12PM - 5PM)</option>
                        <option value="evening">Evening (5PM - 8PM)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="vehicleInfo">Vehicle Information</label>
                    <textarea id="vehicleInfo" rows="2" placeholder="Make, model, year, mileage..."></textarea>
                </div>
                <div class="form-group">
                    <label for="additionalNotes">Additional Notes</label>
                    <textarea id="additionalNotes" rows="3" placeholder="Describe the issue or special requests..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Schedule Service</button>
            </form>
        </div>
    </div>

    <!-- Data Upload Modal -->
    <div class="modal" id="uploadModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Upload Vehicle Data</h2>
                <span class="close" data-modal="uploadModal">&times;</span>
            </div>
            <div class="upload-content">
                <div class="upload-options">
                    <div class="upload-option">
                        <i class="fas fa-camera"></i>
                        <h4>Take Photo</h4>
                        <p>Capture images of your vehicle or issues</p>
                        <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;">
                        <button class="btn btn-outline" onclick="document.getElementById('cameraInput').click()">Open Camera</button>
                    </div>
                    <div class="upload-option">
                        <i class="fas fa-file-upload"></i>
                        <h4>Upload Files</h4>
                        <p>Upload documents, receipts, or diagnostic files</p>
                        <input type="file" id="fileInput" multiple style="display: none;">
                        <button class="btn btn-outline" onclick="document.getElementById('fileInput').click()">Select Files</button>
                    </div>
                    <div class="upload-option">
                        <i class="fas fa-code"></i>
                        <h4>OBD-II Data</h4>
                        <p>Upload OBD-II diagnostic data files</p>
                        <input type="file" id="obdInput" accept=".csv,.txt,.log" style="display: none;">
                        <button class="btn btn-outline" onclick="document.getElementById('obdInput').click()">Upload OBD Data</button>
                    </div>
                </div>
                <div class="uploaded-files" id="uploadedFiles">
                    <!-- Uploaded files will appear here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        let obdCharacteristic = null;
        let repairHistory = JSON.parse(localStorage.getItem('repairHistory')) || [];
        const diagnosisModal = document.getElementById('diagnosisModal');
        const settingsModal = document.getElementById('settingsModal');
        const vehicleValueModal = document.getElementById('vehicleValueModal');
        const repairGuideModal = document.getElementById('repairGuideModal');
        const guideDetailModal = document.getElementById('guideDetailModal');
        const scheduleModal = document.getElementById('scheduleModal');

        // Gemini API integration for chat
        async function fetchGeminiResponse(message) {
            const apiKey = localStorage.getItem('geminiApiKey');
            if (!apiKey) {
                return 'Gemini API key not set. Please add your API key in Settings.';
            }

            try {
                const response = await fetch('https://api.aistudio.google.com/v1/gemini/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        prompt: message,
                        history: chatHistory.filter(msg => msg.sender === 'user' || msg.sender === 'mechanic')
                    })
                });
                const data = await response.json();
                if (data && data.reply) {
                    return data.reply;
                } else {
                    return 'No response from Gemini API.';
                }
            } catch (error) {
                return 'Error communicating with Gemini API: ' + error.message;
            }
        }

        // Override sendChatMessage to use Gemini API
        async function sendChatMessage() {
            const message = chatInput.value.trim();
            if (message) {
                // Add user message
                addChatMessage('user', message);
                chatInput.value = '';

                // Add mechanic typing indicator
                const typingIndicator = document.createElement('div');
                typingIndicator.classList.add('typing-indicator');
                typingIndicator.innerHTML = `
                    <span>Mechanic is typing</span>
                    <div class="typing-dots">
                        <span></span><span></span><span></span>
                    </div>
                `;
                chatMessages.appendChild(typingIndicator);
                chatMessages.scrollTop = chatMessages.scrollHeight;

                // Fetch response from Gemini API
                const reply = await fetchGeminiResponse(message);

                // Remove typing indicator
                typingIndicator.remove();

                // Add mechanic reply
                addChatMessage('mechanic', reply);
            }
        }

        function showHelp() {
            // Update active state
            document.querySelectorAll('.sidebar-menu a').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector('a[onclick="showHelp()"]').classList.add('active');

            // Show help information
            showNotification('Help & Support - Contact us at support@autofix.com or call 1-800-AUTO-FIX');
        }
        
        // Modal Functions
        function showModal(modalId) {
            console.log('showModal called with', modalId);
            const modal = document.getElementById(modalId);
            console.log('modal element:', modal);
            if (modal) {
                modal.style.display = 'flex';
                console.log('modal displayed');
            } else {
                console.log('modal not found');
            }
        }
        
        function hideModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // Scanner Functions
        async function toggleScannerConnection() {
            if (isScannerConnected) {
                disconnectScanner();
            } else {
                await connectScanner();
            }
        }

        async function connectScanner() {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: ['00001101-0000-1000-8000-00805f9b34fb'] }],
                    optionalServices: ['battery_service']
                });
                const server = await device.gatt.connect();
                isScannerConnected = true;
                statusIndicator.classList.add('status-connected');
                statusText.textContent = 'Connected';
                connectScannerBtn.textContent = 'Disconnect Scanner';
                document.getElementById('clearDTCsBtn').style.display = 'inline-block';
                document.getElementById('activeTestBtn').style.display = 'inline-block';

                // Start reading data from OBD-II device
                readOBDData(server);
            } catch (error) {
                showNotification('Failed to connect to OBD-II scanner: ' + error.message);
            }
        }

        function disconnectScanner() {
            isScannerConnected = false;
            obdCharacteristic = null;
            statusIndicator.classList.remove('status-connected');
            statusText.textContent = 'Disconnected';
            connectScannerBtn.textContent = 'Connect Scanner';
            document.getElementById('clearDTCsBtn').style.display = 'none';
            document.getElementById('activeTestBtn').style.display = 'none';
        }

        async function readOBDData(server) {
            if (!isScannerConnected) return;
            try {
        // Get OBD-II service and characteristic
        const service = await server.getPrimaryService('00001101-0000-1000-8000-00805f9b34fb');
        const characteristic = await service.getCharacteristic('00001101-0000-1000-8000-00805f9b34fb');
        obdCharacteristic = characteristic;

                // Read multiple OBD-II parameters
                const obdData = await readMultipleOBDParameters(characteristic);

                updateOBDDisplay(obdData);
                updateOBDVisualization(obdData);
                showNotification(`OBD Data Updated - RPM: ${obdData.engineRPM}, Speed: ${obdData.vehicleSpeed} km/h`);

                // Continue reading data periodically
                setTimeout(() => {
                    readOBDData(server);
                }, 2000);
            } catch (error) {
                showNotification('Error reading OBD-II data: ' + error.message);
                console.error('OBD-II Error:', error);
            }
        }

        async function readMultipleOBDParameters(characteristic) {
            const obdData = {};

            try {
                // Engine RPM (Mode 01, PID 0C)
                obdData.engineRPM = await readOBDPID(characteristic, '010C');
            } catch (e) {
                obdData.engineRPM = 'N/A';
            }

            try {
                // Vehicle Speed (Mode 01, PID 0D)
                obdData.vehicleSpeed = await readOBDPID(characteristic, '010D');
            } catch (e) {
                obdData.vehicleSpeed = 'N/A';
            }

            try {
                // Engine Coolant Temperature (Mode 01, PID 05)
                obdData.engineTemp = await readOBDPID(characteristic, '0105');
            } catch (e) {
                obdData.engineTemp = 'N/A';
            }

            try {
                // Fuel Level (Mode 01, PID 2F)
                obdData.fuelLevel = await readOBDPID(characteristic, '012F');
            } catch (e) {
                obdData.fuelLevel = 'N/A';
            }

            try {
                // Battery Voltage (Mode 01, PID 42 - Control Module Voltage)
                obdData.batteryVoltage = await readOBDPID(characteristic, '0142');
            } catch (e) {
                obdData.batteryVoltage = 'N/A';
            }

            try {
                // Read DTCs (Mode 03)
                obdData.dtcs = await readOBDDTCs(characteristic);
            } catch (e) {
                obdData.dtcs = [];
            }

            return obdData;
        }

        async function readOBDPID(characteristic, pid) {
            // Send OBD-II command
            const command = pid + '\r';
            await characteristic.writeValue(new TextEncoder().encode(command));

            // Wait for response
            await new Promise(resolve => setTimeout(resolve, 100));

            // Read response
            const response = await characteristic.readValue();
            const responseText = new TextDecoder().decode(response);

            // Parse OBD-II response
            return parseOBDResponse(responseText, pid);
        }

        async function readOBDDTCs(characteristic) {
            // Send Mode 03 command to get DTCs
            const command = '03\r';
            await characteristic.writeValue(new TextEncoder().encode(command));

            await new Promise(resolve => setTimeout(resolve, 100));

            const response = await characteristic.readValue();
            const responseText = new TextDecoder().decode(response);

            return parseDTCResponse(responseText);
        }

        function parseOBDResponse(response, pid) {
            // Basic OBD-II response parsing
            const lines = response.split('\r');
            for (const line of lines) {
                if (line.startsWith('41' + pid.slice(2))) {
                    const data = line.slice(4).match(/.{2}/g);
                    if (!data) return 'N/A';

                    switch (pid) {
                        case '010C': // Engine RPM
                            const rpm = ((parseInt(data[0], 16) * 256) + parseInt(data[1], 16)) / 4;
                            return Math.round(rpm);
                        case '010D': // Vehicle Speed
                            return parseInt(data[0], 16);
                        case '0105': // Engine Coolant Temp
                            return parseInt(data[0], 16) - 40;
                        case '012F': // Fuel Level
                            return Math.round((parseInt(data[0], 16) / 255) * 100);
                        case '0142': // Control Module Voltage
                            const voltage = ((parseInt(data[0], 16) * 256) + parseInt(data[1], 16)) / 1000;
                            return voltage.toFixed(1);
                        default:
                            return 'N/A';
                    }
                }
            }
            return 'N/A';
        }

        function parseDTCResponse(response) {
            const dtcs = [];
            const lines = response.split('\r');

            for (const line of lines) {
                if (line.startsWith('43')) {
                    const data = line.slice(2).match(/.{4}/g);
                    if (data) {
                        for (const dtc of data) {
                            if (dtc !== '0000') {
                                dtcs.push(dtc);
                            }
                        }
                    }
                }
            }

            return dtcs;
        }

        async function clearDTCs(characteristic) {
            try {
                const command = '04\r';
                await characteristic.writeValue(new TextEncoder().encode(command));
                await new Promise(resolve => setTimeout(resolve, 100));
                const response = await characteristic.readValue();
                const responseText = new TextDecoder().decode(response);
                if (responseText.includes('44')) {
                    showNotification('DTCs cleared successfully.');
                    // Update display to show no DTCs
                    const displayDiv = document.querySelector('.scanner-data');
                    if (displayDiv) {
                        const dtcElement = displayDiv.querySelector('.dtc-list');
                        if (dtcElement) {
                            dtcElement.innerHTML = 'No DTCs';
                        }
                    }
                } else {
                    showNotification('Failed to clear DTCs. Response: ' + responseText);
                }
            } catch (error) {
                showNotification('Error clearing DTCs: ' + error.message);
            }
        }

        async function performActiveTests(characteristic) {
            try {
                const command = '06\r';
                await characteristic.writeValue(new TextEncoder().encode(command));
                await new Promise(resolve => setTimeout(resolve, 100));
                const response = await characteristic.readValue();
                const responseText = new TextDecoder().decode(response);
                // Parse active test results (simplified)
                const results = parseActiveTestResponse(responseText);
                showNotification('Active tests performed. Check results.');
                // Display in scanner-data
                const displayDiv = document.querySelector('.scanner-data');
                if (displayDiv) {
                    let activeTestDiv = displayDiv.querySelector('.active-test-results');
                    if (!activeTestDiv) {
                        activeTestDiv = document.createElement('div');
                        activeTestDiv.className = 'active-test-results';
                        displayDiv.appendChild(activeTestDiv);
                    }
                    activeTestDiv.innerHTML = '<h4>Active Test Results:</h4><p>' + results + '</p>';
                }
            } catch (error) {
                showNotification('Error performing active tests: ' + error.message);
            }
        }

        function parseActiveTestResponse(response) {
            // Simplified parsing for Mode 06
            const lines = response.split('\r');
            let results = '';
            for (const line of lines) {
                if (line.startsWith('46')) {
                    // Parse test ID, etc.
                    results += 'Test data: ' + line + '\n';
                }
            }
            return results || 'No active test data available.';
        }

        function generateRandomDTC() {
            const codes = ['P0300', 'P0171', 'P0420', 'P0128', 'P0135', 'P0442', 'P0455', 'P0606'];
            return codes[Math.floor(Math.random() * codes.length)];
        }

        function updateOBDDisplay(data) {
            let displayDiv = document.querySelector('.scanner-data');
            if (!displayDiv) {
                displayDiv = document.createElement('div');
                displayDiv.className = 'scanner-data';
                document.querySelector('.scanner-info').appendChild(displayDiv);
            }

            const dtcDisplay = data.dtcs && data.dtcs.length > 0
                ? data.dtcs.map(dtc => `<span class="dtc-code">${dtc}</span>`).join(', ')
                : 'No DTCs';

            displayDiv.innerHTML = `
                <h4>Live OBD-II Data:</h4>
                <div class="data-grid">
                    <div class="data-item">
                        <span class="data-label">Engine RPM:</span>
                        <span class="data-value">${data.engineRPM}${data.engineRPM !== 'N/A' ? ' RPM' : ''}</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Vehicle Speed:</span>
                        <span class="data-value">${data.vehicleSpeed}${data.vehicleSpeed !== 'N/A' ? ' km/h' : ''}</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Engine Temp:</span>
                        <span class="data-value">${data.engineTemp}${data.engineTemp !== 'N/A' ? 'C' : ''}</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Fuel Level:</span>
                        <span class="data-value">${data.fuelLevel}${data.fuelLevel !== 'N/A' ? '%' : ''}</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Battery Voltage:</span>
                        <span class="data-value">${data.batteryVoltage}${data.batteryVoltage !== 'N/A' ? 'V' : ''}</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">DTCs:</span>
                        <span class="data-value dtc-list">${dtcDisplay}</span>
                    </div>
                </div>
            `;
        }

        function updateOBDVisualization(data) {
            // Create or update visualization container
            let vizContainer = document.querySelector('.obd-visualization');
            if (!vizContainer) {
                vizContainer = document.createElement('div');
                vizContainer.className = 'obd-visualization';
                document.querySelector('.scanner-info').appendChild(vizContainer);
            }

            // Create gauge visualizations for key metrics
            vizContainer.innerHTML = `
                <h4>Real-time Gauges:</h4>
                <div class="gauges-container">
                    <div class="gauge">
                        <div class="gauge-label">RPM</div>
                        <div class="gauge-value">${data.engineRPM !== 'N/A' ? data.engineRPM : '--'}</div>
                        <div class="gauge-bar">
                            <div class="gauge-fill" style="width: ${data.engineRPM !== 'N/A' ? Math.min((data.engineRPM / 6000) * 100, 100) : 0}%"></div>
                        </div>
                    </div>
                    <div class="gauge">
                        <div class="gauge-label">Speed</div>
                        <div class="gauge-value">${data.vehicleSpeed !== 'N/A' ? data.vehicleSpeed : '--'}</div>
                        <div class="gauge-bar">
                            <div class="gauge-fill" style="width: ${data.vehicleSpeed !== 'N/A' ? Math.min((data.vehicleSpeed / 200) * 100, 100) : 0}%"></div>
                        </div>
                    </div>
                    <div class="gauge">
                        <div class="gauge-label">Temp</div>
                        <div class="gauge-value">${data.engineTemp !== 'N/A' ? data.engineTemp : '--'}</div>
                        <div class="gauge-bar">
                            <div class="gauge-fill" style="width: ${data.engineTemp !== 'N/A' ? Math.min(((data.engineTemp + 40) / 140) * 100, 100) : 0}%"></div>
                        </div>
                    </div>
                    <div class="gauge">
                        <div class="gauge-label">Fuel</div>
                        <div class="gauge-value">${data.fuelLevel !== 'N/A' ? data.fuelLevel : '--'}</div>
                        <div class="gauge-bar">
                            <div class="gauge-fill" style="width: ${data.fuelLevel !== 'N/A' ? data.fuelLevel : 0}%"></div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Troubleshooting State
        let currentTroubleshootingStep = 1;
        let selectedProblem = null;
        let troubleshootingHistory = [];

        // Troubleshooting Functions
        function startTroubleshooting(problem) {
            selectedProblem = problem;
            currentTroubleshootingStep = 1;
            troubleshootingHistory = [problem];

            showNotification(`Starting diagnosis for: ${problem.replace(/-/g, ' ')}`);

            // Show step 2 based on the selected problem
            showTroubleshootingStep(2, problem);
        }

        function showTroubleshootingStep(stepNumber, problem = selectedProblem) {
            currentTroubleshootingStep = stepNumber;
            const flowContainer = document.getElementById('troubleshootingFlow');
            const prevBtn = document.getElementById('prevStepBtn');
            const restartBtn = document.getElementById('restartTroubleshootingBtn');

            // Hide all steps
            document.querySelectorAll('.flow-step').forEach(step => {
                step.classList.remove('active');
            });

            // Show current step
            const currentStepEl = document.getElementById(`step${stepNumber}`);
            if (currentStepEl) {
                currentStepEl.classList.add('active');
            } else {
                // Create new step if it doesn't exist
                createTroubleshootingStep(stepNumber, problem);
            }

            // Update controls
            prevBtn.style.display = stepNumber > 1 ? 'inline-block' : 'none';
            restartBtn.style.display = stepNumber > 1 ? 'inline-block' : 'none';
        }

        function createTroubleshootingStep(stepNumber, problem) {
            const flowContainer = document.getElementById('troubleshootingFlow');
            let stepContent = '';

            switch (stepNumber) {
                case 2:
                    stepContent = createStep2Content(problem);
                    break;
                case 3:
                    stepContent = createStep3Content(problem);
                    break;
                case 4:
                    stepContent = createStep4Content(problem);
                    break;
                default:
                    return;
            }

            const stepEl = document.createElement('div');
            stepEl.className = 'flow-step active';
            stepEl.id = `step${stepNumber}`;
            stepEl.innerHTML = stepContent;
            flowContainer.appendChild(stepEl);

            // Attach event listeners to new buttons
            const newButtons = stepEl.querySelectorAll('.option-btn');
            newButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    const nextStep = e.target.getAttribute('data-next');
                    if (nextStep) {
                        showTroubleshootingStep(parseInt(nextStep));
                    }
                });
            });
        }

        function createStep2Content(problem) {
            const questions = {
                'engine-wont-start': [
                    { text: 'Does the engine crank but not start?', nextStep: 3, data: 'cranks-no-start' },
                    { text: 'Does the engine not crank at all?', nextStep: 3, data: 'no-crank' },
                    { text: 'Do you hear clicking sounds?', nextStep: 3, data: 'clicking-sounds' }
                ],
                'engine-misfires': [
                    { text: 'Does it happen at idle?', nextStep: 3, data: 'idle-misfire' },
                    { text: 'Does it happen under acceleration?', nextStep: 3, data: 'accel-misfire' },
                    { text: 'Is there a check engine light?', nextStep: 3, data: 'check-engine-on' }
                ],
                'poor-fuel-economy': [
                    { text: 'Have you noticed any leaks?', nextStep: 3, data: 'fuel-leaks' },
                    { text: 'Is your driving style aggressive?', nextStep: 3, data: 'driving-habit' },
                    { text: 'Have maintenance schedules been followed?', nextStep: 3, data: 'maintenance' }
                ],
                'warning-light': [
                    { text: 'Which warning light is on?', nextStep: 3, data: 'check-light-type' },
                    { text: 'When did it come on?', nextStep: 3, data: 'light-timing' }
                ],
                'braking-issues': [
                    { text: 'Do you hear grinding noises?', nextStep: 3, data: 'grinding-brakes' },
                    { text: 'Does the pedal feel soft?', nextStep: 3, data: 'soft-pedal' },
                    { text: 'Does the car pull to one side?', nextStep: 3, data: 'pulling' }
                ],
                'overheating': [
                    { text: 'Is the temperature gauge in the red?', nextStep: 3, data: 'red-gauge' },
                    { text: 'Do you see steam from the hood?', nextStep: 3, data: 'steam' },
                    { text: 'Does the heat work in the cabin?', nextStep: 3, data: 'heater-works' }
                ],
                'strange-noises': [
                    { text: 'What type of noise?', nextStep: 3, data: 'noise-type' },
                    { text: 'When does it occur?', nextStep: 3, data: 'noise-timing' }
                ]
            };

            const problemQuestions = questions[problem] || [
                { text: 'Please describe your issue in detail', nextStep: 3, data: 'custom-issue' }
            ];

            return `
                <div class="step-header">
                    <h3 class="step-title">Additional Details</h3>
                    <span>Step 2 of 4</span>
                </div>
                <p>Please answer the following question to help diagnose the issue:</p>
                <div class="step-options">
                    ${problemQuestions.map(q => `<button class="option-btn" data-next="${q.nextStep}" data-detail="${q.data}">${q.text}</button>`).join('')}
                </div>
            `;
        }

        function createStep3Content(problem) {
            return `
                <div class="step-header">
                    <h3 class="step-title">Diagnostic Results</h3>
                    <span>Step 3 of 4</span>
                </div>
                <div class="diagnostic-results">
                    <h4>Based on your symptoms, here's what we found:</h4>
                    <p>${getDiagnosticResult(problem)}</p>
                </div>
                <div class="step-options">
                    <button class="option-btn" data-next="4">Show Repair Solutions</button>
                    <button class="option-btn" onclick="showModal('diagnosisModal')">Get Professional Help</button>
                </div>
            `;
        }

        function createStep4Content(problem) {
            return `
                <div class="step-header">
                    <h3 class="step-title">Repair Solutions</h3>
                    <span>Step 4 of 4</span>
                </div>
                <div class="safety-warning">
                    <strong> Safety Warning:</strong>
                    Always ensure the vehicle is safely parked and the engine is off before performing any repairs. If you're not comfortable with these procedures, consult a professional mechanic.
                </div>
                <div class="solution-steps">
                    ${getRepairSolutions(problem)}
                </div>
                <div class="step-options">
                    <button class="option-btn" onclick="scheduleRepair('${problem}')">Schedule Repair</button>
                    <button class="option-btn" onclick="contactMechanic('${problem}')">Contact Mechanic</button>
                </div>
            `;
        }

        function getDiagnosticResult(problem) {
            const results = {
                'engine-wont-start': 'Your symptoms suggest a possible battery, starter, or fuel system issue. Common causes include dead battery, faulty starter, or fuel pump failure.',
                'engine-misfires': 'Engine misfires are often caused by faulty spark plugs, ignition coils, or fuel injectors. The check engine light indicates diagnostic trouble codes are stored.',
                'poor-fuel-economy': 'Poor fuel economy can result from dirty air filters, faulty oxygen sensors, or issues with the fuel system. Driving habits also play a significant role.',
                'warning-light': 'Dashboard warning lights indicate specific system malfunctions. The check engine light suggests OBD-II codes are available for diagnosis.',
                'braking-issues': 'Braking problems require immediate attention. Grinding noises suggest worn brake pads, while soft pedals may indicate air in the brake lines.',
                'overheating': 'Engine overheating is serious and can cause major damage. Common causes include low coolant, faulty thermostat, or radiator issues.',
                'strange-noises': 'Unusual noises often indicate mechanical issues. Grinding suggests worn components, while squealing may indicate belt or bearing problems.'
            };
            return results[problem] || 'Please provide more details for accurate diagnosis.';
        }

        function getRepairSolutions(problem) {
            const solutions = {
                'engine-wont-start': `
                    <div class="solution-step">
                        <div class="step-number">1</div>
                        <div>
                            <strong>Check Battery Connections</strong>
                            <p>Ensure battery terminals are clean and tightly connected. Test battery voltage (should be 12.6V+ when off).</p>
                        </div>
                    </div>
                    <div class="solution-step">
                        <div class="step-number">2</div>
                        <div>
                            <strong>Test Starter</strong>
                            <p>Listen for clicking when turning the key. If you hear clicks but no cranking, the starter may be faulty.</p>
                        </div>
                    </div>
                    <div class="solution-step">
                        <div class="step-number">3</div>
                        <div>
                            <strong>Check Fuel System</strong>
                            <p>Ensure there's fuel in the tank and the fuel pump is working (listen for humming when turning key to ON).</p>
                        </div>
                    </div>
                `,
                'engine-misfires': `
                    <div class="solution-step">
                        <div class="step-number">1</div>
                        <div>
                            <strong>Replace Spark Plugs</strong>
                            <p>Spark plugs should be replaced every 30,000-100,000 miles depending on type. Check gap and condition.</p>
                        </div>
                    </div>
                    <div class="solution-step">
                        <div class="step-number">2</div>
                        <div>
                            <strong>Check Ignition Coils</strong>
                            <p> faulty ignition coils can cause misfires. Test each coil for proper voltage output.</p>
                        </div>
                    </div>
                `,
                'braking-issues': `
                    <div class="solution-step">
                        <div class="step-number">1</div>
                        <div>
                            <strong>Inspect Brake Pads</strong>
                            <p>Check brake pad thickness through the caliper inspection window. Replace if less than 1/4 inch thick.</p>
                        </div>
                    </div>
                    <div class="solution-step">
                        <div class="step-number">2</div>
                        <div>
                            <strong>Bleed Brake Lines</strong>
                            <p>If the brake pedal feels soft, there may be air in the lines. Bleed brakes starting with the wheel farthest from the master cylinder.</p>
                        </div>
                    </div>
                `,
                'overheating': `
                    <div class="solution-step">
                        <div class="step-number">1</div>
                        <div>
                            <strong>Check Coolant Level</strong>
                            <p>Ensure coolant is at the proper level in the radiator and overflow tank. Never open the radiator when hot.</p>
                        </div>
                    </div>
                    <div class="solution-step">
                        <div class="step-number">2</div>
                        <div>
                            <strong>Test Thermostat</strong>
                            <p>A stuck thermostat can cause overheating. Test by feeling radiator hose temperature after engine warms up.</p>
                        </div>
                    </div>
                `
            };
            return solutions[problem] || '<p>Please consult a professional mechanic for diagnosis and repair of this issue.</p>';
        }

        function previousTroubleshootingStep() {
            if (currentTroubleshootingStep > 1) {
                showTroubleshootingStep(currentTroubleshootingStep - 1);
            }
        }

        function restartTroubleshooting() {
            currentTroubleshootingStep = 1;
            selectedProblem = null;
            troubleshootingHistory = [];

            // Hide all steps except step 1
            document.querySelectorAll('.flow-step').forEach((step, index) => {
                if (index === 0) {
                    step.classList.add('active');
                } else {
                    step.classList.remove('active');
                }
            });

            // Hide controls
            document.getElementById('prevStepBtn').style.display = 'none';
            document.getElementById('restartTroubleshootingBtn').style.display = 'none';
        }

        function scheduleRepair(problem) {
            showNotification('Opening repair scheduling...');
            // This would integrate with a scheduling system
        }

        function contactMechanic(problem) {
            document.querySelector('.chat-container').scrollIntoView({ behavior: 'smooth' });
            const message = `I need help with ${problem.replace(/-/g, ' ')}. Can you assist me?`;
            document.getElementById('chatInput').value = message;
            sendChatMessage();
        }

        // Repair Guide Functions
        function openRepairGuide() {
            showModal('repairGuideModal');
            loadRepairGuides('engine');
        }

        function loadRepairGuides(category) {
            const guides = getRepairGuidesByCategory(category);
            const guideList = document.getElementById('guideList');

            guideList.innerHTML = guides.map(guide => `
                <div class="guide-item" onclick="openGuideDetail('${guide.id}')">
                    <h4>${guide.title}</h4>
                    <p>${guide.description}</p>
                    <span class="difficulty ${guide.difficulty}">${guide.difficulty.charAt(0).toUpperCase() + guide.difficulty.slice(1)}</span>
                </div>
            `).join('');

            // Update active category button
            document.querySelectorAll('.guide-category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-category="${category}"]`).classList.add('active');
        }

        function openGuideDetail(guideId) {
            const guide = getGuideById(guideId);
            if (!guide) return;

            document.getElementById('guideTitle').textContent = guide.title;
            document.getElementById('guideDetailContent').innerHTML = `
                <div class="guide-intro">
                    <p><strong>Difficulty:</strong> <span class="difficulty ${guide.difficulty}">${guide.difficulty.charAt(0).toUpperCase() + guide.difficulty.slice(1)}</span></p>
                    <p><strong>Time Required:</strong> ${guide.time}</p>
                    <p>${guide.description}</p>
                </div>

                ${guide.parts ? `
                <div class="guide-parts">
                    <h4>Parts Needed:</h4>
                    <ul>
                        ${guide.parts.map(part => `<li>${part}</li>`).join('')}
                    </ul>
                </div>
                ` : ''}

                ${guide.tools ? `
                <div class="guide-tools">
                    <h4>Tools Required:</h4>
                    <ul>
                        ${guide.tools.map(tool => `<li>${tool}</li>`).join('')}
                    </ul>
                </div>
                ` : ''}

                <h3>Safety Precautions</h3>
                <ul>
                    ${guide.safety.map(item => `<li>${item}</li>`).join('')}
                </ul>

                <h3>Step-by-Step Instructions</h3>
                <ol>
                    ${guide.steps.map(step => `<li>${step}</li>`).join('')}
                </ol>

                ${guide.tips ? `
                <h3>Pro Tips</h3>
                <ul>
                    ${guide.tips.map(tip => `<li>${tip}</li>`).join('')}
                </ul>
                ` : ''}
            `;

            hideModal('repairGuideModal');
            showModal('guideDetailModal');
        }

        function getRepairGuidesByCategory(category) {
            const allGuides = {
                engine: [
                    { id: 'oil-change', title: 'Oil Change', description: 'Complete guide to changing your engine oil and filter', difficulty: 'easy', time: '30-45 minutes' },
                    { id: 'spark-plugs', title: 'Replace Spark Plugs', description: 'Step-by-step guide to replacing spark plugs', difficulty: 'medium', time: '1-2 hours' },
                    { id: 'air-filter', title: 'Replace Air Filter', description: 'How to replace your engine air filter', difficulty: 'easy', time: '15-20 minutes' },
                    { id: 'battery-replace', title: 'Replace Car Battery', description: 'Complete guide to replacing your car battery', difficulty: 'easy', time: '20-30 minutes' }
                ],
                brakes: [
                    { id: 'brake-pads', title: 'Replace Brake Pads', description: 'Front brake pad replacement guide', difficulty: 'medium', time: '1-2 hours' },
                    { id: 'brake-rotors', title: 'Replace Brake Rotors', description: 'Complete brake rotor replacement', difficulty: 'hard', time: '2-3 hours' },
                    { id: 'brake-fluid', title: 'Flush Brake Fluid', description: 'How to flush and replace brake fluid', difficulty: 'medium', time: '45-60 minutes' }
                ],
                transmission: [
                    { id: 'transmission-fluid', title: 'Change Transmission Fluid', description: 'Transmission fluid change guide', difficulty: 'medium', time: '1-1.5 hours' },
                    { id: 'transmission-filter', title: 'Replace Transmission Filter', description: 'Transmission filter replacement', difficulty: 'hard', time: '2-3 hours' }
                ],
                electrical: [
                    { id: 'headlight-bulb', title: 'Replace Headlight Bulb', description: 'How to replace headlight bulbs', difficulty: 'easy', time: '15-30 minutes' },
                    { id: 'battery-cables', title: 'Clean Battery Cables', description: 'Battery terminal cleaning and maintenance', difficulty: 'easy', time: '20-30 minutes' },
                    { id: 'fuse-replace', title: 'Replace Fuses', description: 'How to locate and replace blown fuses', difficulty: 'easy', time: '10-15 minutes' }
                ],
                suspension: [
                    { id: 'shock-absorbers', title: 'Replace Shock Absorbers', description: 'Shock absorber replacement guide', difficulty: 'hard', time: '3-4 hours' },
                    { id: 'control-arms', title: 'Replace Control Arms', description: 'Control arm replacement procedure', difficulty: 'hard', time: '4-6 hours' }
                ],
                maintenance: [
                    { id: 'tire-rotation', title: 'Tire Rotation', description: 'Proper tire rotation pattern and procedure', difficulty: 'easy', time: '30-45 minutes' },
                    { id: 'wiper-blades', title: 'Replace Wiper Blades', description: 'Wiper blade replacement guide', difficulty: 'easy', time: '10-15 minutes' },
                    { id: 'coolant-flush', title: 'Coolant System Flush', description: 'Complete cooling system flush and refill', difficulty: 'medium', time: '1-2 hours' }
                ]
            };

            return allGuides[category] || [];
        }

        function getGuideById(id) {
            const allGuides = {
                'oil-change': {
                    title: 'Complete Oil Change Guide',
                    difficulty: 'easy',
                    time: '30-45 minutes',
                    description: 'Learn how to perform a complete oil change on your vehicle.',
                    parts: ['Motor oil (check your owner\'s manual for type and quantity)', 'Oil filter', 'Oil filter wrench', 'Drain pan', 'Funnel'],
                    tools: ['Jack and jack stands (if needed)', 'Wheel chocks', 'Gloves', 'Rags'],
                    safety: ['Ensure vehicle is on level ground', 'Allow engine to cool before starting', 'Wear safety glasses and gloves', 'Never work under a vehicle supported only by a jack'],
                    steps: [
                        'Park on level ground and engage parking brake',
                        'Allow engine to cool completely (at least 30 minutes)',
                        'Locate oil drain plug under vehicle',
                        'Place drain pan under plug and remove drain plug',
                        'Allow old oil to drain completely (10-15 minutes)',
                        'Replace drain plug gasket if damaged',
                        'Reinstall drain plug and tighten to specification',
                        'Locate and remove old oil filter',
                        'Apply oil to new filter gasket and install new filter',
                        'Lower vehicle and add new oil using funnel',
                        'Check oil level with dipstick and add more if needed',
                        'Start engine and check for leaks',
                        'Turn off engine and recheck oil level'
                    ],
                    tips: [
                        'Always use the correct oil viscosity for your vehicle',
                        'Dispose of old oil at an auto parts store or recycling center',
                        'Reset your oil change reminder if equipped',
                        'Check oil level after driving a few miles'
                    ]
                },
                'spark-plugs': {
                    title: 'Spark Plug Replacement Guide',
                    difficulty: 'medium',
                    time: '1-2 hours',
                    description: 'Step-by-step guide to replacing spark plugs in your vehicle.',
                    parts: ['New spark plugs (check gap specifications)', 'Spark plug socket', 'Extension bars', 'Gap tool'],
                    tools: ['Ratchet', 'Spark plug gap tool', 'Anti-seize compound (optional)'],
                    safety: ['Allow engine to cool completely', 'Wear safety glasses', 'Keep work area clear of flammable materials'],
                    steps: [
                        'Consult service manual for spark plug location and specifications',
                        'Allow engine to cool completely',
                        'Remove ignition coil or spark plug wire from first plug',
                        'Clean area around spark plug hole',
                        'Remove spark plug using proper socket size',
                        'Inspect old plug for condition and gap',
                        'Gap new spark plug to specification',
                        'Apply anti-seize to threads if recommended',
                        'Install new spark plug and tighten to specification',
                        'Reconnect ignition coil or wire',
                        'Repeat for remaining spark plugs',
                        'Start engine and listen for misfires'
                    ],
                    tips: [
                        'Replace spark plugs one at a time to avoid mixing up wires',
                        'Use dielectric grease on boot connections',
                        'Check plug gap with a wire feeler gauge',
                        'Note the condition of old plugs for diagnostic purposes'
                    ]
                }
            };

            return allGuides[id];
        }

        // Scheduling Functions
        function openScheduleModal() {
            showModal('scheduleModal');
            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('preferredDate').min = today;
        }

        function handleScheduleSubmit(e) {
            e.preventDefault();

            const formData = {
                serviceType: document.getElementById('serviceType').value,
                preferredDate: document.getElementById('preferredDate').value,
                preferredTime: document.getElementById('preferredTime').value,
                vehicleInfo: document.getElementById('vehicleInfo').value,
                additionalNotes: document.getElementById('additionalNotes').value
            };

            // In a real app, this would send data to a server
            console.log('Scheduling service:', formData);

            // Add to repair history
            const newRepair = {
                id: Date.now(),
                title: `${formData.serviceType.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())} Service`,
                vehicle: formData.vehicleInfo || 'Your Vehicle',
                date: formData.preferredDate,
                status: 'scheduled'
            };

            repairHistory.push(newRepair);
            localStorage.setItem('repairHistory', JSON.stringify(repairHistory));

            showNotification('Service scheduled successfully! You will receive a confirmation soon.');
            hideModal('scheduleModal');
            renderRepairHistory();

            // Reset form
            e.target.reset();
        }

        // Upload Functions
        function openUploadModal() {
            showModal('uploadModal');
        }

        function handleFileUpload(inputId, files) {
            const uploadedFiles = document.getElementById('uploadedFiles');

            Array.from(files).forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'uploaded-file';
                fileItem.innerHTML = `
                    <div class="file-info">
                        <i class="fas fa-file"></i>
                        <span>${file.name} (${(file.size / 1024).toFixed(1)} KB)</span>
                    </div>
                    <button class="btn btn-sm btn-outline" onclick="removeUploadedFile(this)">Remove</button>
                `;
                uploadedFiles.appendChild(fileItem);

                // In a real app, you would upload the file to a server here
                console.log('File uploaded:', file.name);
            });

            showNotification(`${files.length} file(s) uploaded successfully.`);
        }

        function removeUploadedFile(button) {
            button.parentElement.remove();
        }
        
        // Chat Functions
        async function sendChatMessage() {
            const message = chatInput.value.trim();
            if (message) {
                // Add user message
                addChatMessage('user', message);
                chatInput.value = '';

                // Add mechanic typing indicator
                const typingIndicator = document.createElement('div');
                typingIndicator.classList.add('typing-indicator');
                typingIndicator.innerHTML = `
                    <span>Mechanic is typing</span>
                    <div class="typing-dots">
                        <span></span><span></span><span></span>
                    </div>
                `;
                chatMessages.appendChild(typingIndicator);
                chatMessages.scrollTop = chatMessages.scrollHeight;

                // Send message to Gemini API if API key is set
                const apiKey = localStorage.getItem('geminiApiKey');
                if (apiKey) {
                    try {
                        const response = await fetch('https://api.aistudio.google.com/v1/gemini/chat', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${apiKey}`
                            },
                            body: JSON.stringify({
                                prompt: message,
                                history: chatHistory.filter(msg => msg.sender === 'user' || msg.sender === 'mechanic')
                            })
                        });
                        const data = await response.json();
                        // Remove typing indicator
                        typingIndicator.remove();
                        if (data && data.reply) {
                            addChatMessage('mechanic', data.reply);
                        } else {
                            addChatMessage('mechanic', 'Sorry, no response from Gemini API.');
                        }
                    } catch (error) {
                        typingIndicator.remove();
                        addChatMessage('mechanic', 'Error communicating with Gemini API: ' + error.message);
                    }
                } else {
                    // Remove typing indicator
                    typingIndicator.remove();
                    // Simulate mechanic response after a delay
                    setTimeout(() => {
                        const responses = [
                            "I understand. Could you tell me more about when this problem occurs?",
                            "Thanks for that information. Let me check the database for similar issues.",
                            "Based on what you're describing, it might be related to the power steering system.",
                            "Have you noticed any fluid leaks under your vehicle?",
                            "When was the last time you had your power steering fluid checked?"
                        ];
                        const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                        addChatMessage('mechanic', randomResponse);
                    }, 1500);
                }
            }
        }
        
        function addChatMessage(sender, text) {
            const now = new Date();
            const time = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            const messageEl = document.createElement('div');
            messageEl.classList.add('message', sender === 'user' ? 'sent' : 'received');
            messageEl.innerHTML = `
                <p>${text}</p>
                <span class="message-time">${time}</span>
            `;
            
            chatMessages.appendChild(messageEl);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Add to chat history
            chatHistory.push({ sender, text, time });
        }
        
        // Form Handlers
        function handleNewDiagnosis(e) {
            e.preventDefault();
            const vehicleType = document.getElementById('vehicleType').value;
            const make = document.getElementById('vehicleMake').value;
            const model = document.getElementById('vehicleModel').value;
            const year = document.getElementById('vehicleYear').value;

            // Simulate diagnosis process
            showNotification(`Starting diagnosis for ${year} ${make} ${model} (${vehicleType})`);
            hideModal('diagnosisModal');

            // Simulate diagnosis results after a delay
            setTimeout(() => {
                showNotification('Diagnosis complete! View the results and recommended repairs.');
            }, 3000);
        }

        function handleSettingsSave(e) {
            e.preventDefault();
            const apiKey = document.getElementById('geminiApiKey').value.trim();
            const darkModeEnabled = document.getElementById('darkModeToggle').checked;

            if (apiKey) {
                localStorage.setItem('geminiApiKey', apiKey);
                showNotification('Gemini API key saved successfully.');
            } else {
                localStorage.removeItem('geminiApiKey');
                showNotification('Gemini API key removed.');
            }

            // Handle dark mode
            localStorage.setItem('darkMode', darkModeEnabled);
            toggleDarkMode(darkModeEnabled);

            showNotification('Settings saved successfully.');
            hideModal('settingsModal');
        }

        function toggleDarkMode(enabled) {
            if (enabled) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
        }
        
        // Action Button Handlers
        function handleActionButtonClick(buttonId) {
            switch(buttonId) {
                case 'newDiagnosisBtn':
                    showModal('diagnosisModal');
                    break;
                case 'repairGuideBtn':
                    openRepairGuide();
                    break;
                case 'repairHistoryBtn':
                    document.querySelector('.history-list').scrollIntoView({ behavior: 'smooth' });
                    showNotification('Viewing Repair History');
                    break;
                case 'scheduleBtn':
                    openScheduleModal();
                    break;
                case 'chatSupportBtn':
                    document.querySelector('.chat-container').scrollIntoView({ behavior: 'smooth' });
                    chatInput.focus();
                    break;
                case 'uploadDataBtn':
                    openUploadModal();
                    break;
                case 'vehicleValueBtn':
                    showModal('vehicleValueModal');
                    break;
            }
        }
        
        // Vehicle Value Form Handler
        function handleVehicleValueSubmit(e) {
            e.preventDefault();
            const make = document.getElementById('vvMake').value.trim();
            const model = document.getElementById('vvModel').value.trim();
            const year = parseInt(document.getElementById('vvYear').value);
            const mileage = parseInt(document.getElementById('vvMileage').value);

            if (!make || !model || !year || isNaN(mileage)) {
                showNotification('Please fill in all fields correctly.');
                return;
            }

            // Simple vehicle value estimation logic
            const currentYear = new Date().getFullYear();
            const age = currentYear - year;
            let baseValue = 20000; // Base value in dollars

            // Adjust base value by vehicle age
            baseValue -= age * 1000;

            // Adjust base value by mileage
            baseValue -= mileage * 0.05;

            // Ensure value is not negative
            if (baseValue < 1000) baseValue = 1000;

            // Display estimated value
            vehicleValueResult.textContent = `Estimated value for your ${year} ${make} ${model} with ${mileage.toLocaleString()} km is $${baseValue.toFixed(2)}.`;
        }
        
        // Utility Functions
        function showNotification(message) {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.position = 'fixed';
            notification.style.bottom = '20px';
            notification.style.right = '20px';
            notification.style.backgroundColor = 'var(--primary)';
            notification.style.color = 'white';
            notification.style.padding = '12px 20px';
            notification.style.borderRadius = '4px';
            notification.style.boxShadow = 'var(--shadow)';
            notification.style.zIndex = '1000';
            notification.style.maxWidth = '300px';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Remove notification after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.5s';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 500);
            }, 3000);
        }
        
        // Initialize the app
        function initApp() {
            // Load repair history
            renderRepairHistory();

            // Load chat history
            chatHistory.forEach(msg => {
                addChatMessage(msg.sender, msg.text);
            });

            // Load dark mode setting
            const darkModeEnabled = localStorage.getItem('darkMode') === 'true';
            toggleDarkMode(darkModeEnabled);
        }
        
        function renderRepairHistory() {
            const historyList = document.getElementById('repairHistoryList');
            historyList.innerHTML = '';

            repairHistory.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.classList.add('history-item');

                historyItem.innerHTML = `
                    <div class="history-details">
                        <h4>${item.title}</h4>
                        <p>Vehicle: ${item.vehicle}</p>
                        <span class="history-date">${item.status === 'completed' ? 'Completed' : 'Scheduled'}: ${item.date}</span>
                    </div>
                    <div class="history-status">
                        <span style="background: ${item.status === 'completed' ? 'var(--success)' : 'var(--warning)'}; color: white; padding: 0.3rem 0.6rem; border-radius: 4px;">
                            ${item.status === 'completed' ? 'Completed' : 'Scheduled'}
                        </span>
                    </div>
                `;

                historyList.appendChild(historyItem);
            });
        }

        // Close modal when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('Service Worker registered successfully:', registration);
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }

        // Install Prompt
        let deferredPrompt;
        const installBtn = document.createElement('button');
        installBtn.className = 'btn btn-success';
        installBtn.innerHTML = '<i class="fas fa-download"></i> Install App';
        installBtn.style.display = 'none';
        document.querySelector('.user-actions').appendChild(installBtn);

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installBtn.style.display = 'inline-block';
        });

        installBtn.addEventListener('click', () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    } else {
                        console.log('User dismissed the install prompt');
                    }
                    deferredPrompt = null;
                    installBtn.style.display = 'none';
                });
            }
        });

        // Event listeners for new buttons
        document.getElementById('clearDTCsBtn').addEventListener('click', () => {
            if (obdCharacteristic) {
                clearDTCs(obdCharacteristic);
            } else {
                showNotification('Scanner not connected.');
            }
        });

        document.getElementById('activeTestBtn').addEventListener('click', () => {
            if (obdCharacteristic) {
                performActiveTests(obdCharacteristic);
            } else {
                showNotification('Scanner not connected.');
            }
        });

        // Initialize the application
        initApp();

        // Add event listener for Settings button
        document.getElementById('settingsBtn').addEventListener('click', () => {
            showModal('settingsModal');
        });

        // Loader functionality
        function showLoader() {
            const loader = document.getElementById('loader');
            loader.classList.remove('hidden');
        }

        function hideLoader() {
            const loader = document.getElementById('loader');
            setTimeout(() => {
                loader.classList.add('hidden');
            }, 500); // Wait for fade out animation
        }

        // Show loader on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                hideLoader();
                // Add fade-in animations to main content
                document.querySelector('.dashboard').classList.add('fade-in');
                document.querySelectorAll('.card').forEach(card => {
                    card.classList.add('slide-in-left');
                });
            }, 3000); // Show loader for 3 seconds
        });
    </script>
</body>
</html>
